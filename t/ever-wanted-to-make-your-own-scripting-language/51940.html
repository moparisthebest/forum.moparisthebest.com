<!DOCTYPE html>
<html lang="en-US">
  
<!-- Mirrored from forum.moparisthebest.com/t/ever-wanted-to-make-your-own-scripting-language/51940 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 19:49:04 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Ever Wanted to make your own scripting language? - General Programming - moparisthebest.com</title>
    <meta name="description" content="Taken off flipcode. :slight_smile: 

Introduction 

Okay. You want a scripting language for your engine. Why? Because they&amp;#39;re just really cool, and everybody has &amp;#39;em these days. 

First, decide what kind of scripting you&amp;hellip;">
    <meta name="generator" content="Discourse 2.3.2 - https://github.com/discourse/discourse version c587df7e2a03c2962f4c8cefd6f03969bb87d525">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/1/1f0dc167bcf798bdbd70b03bf0fd1bc836e54e1a_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff_2_180x180.png">
<meta name="theme-color" content="#0088cc">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="51940.html" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://forum.moparisthebest.com","potentialAction":{"@type":"SearchAction","target":"https://forum.moparisthebest.com/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="moparisthebest.com Search">

      <link href="../../stylesheets/desktop_1_ec9f75e3d0b2a904642ce53663991837b70cda3334fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2"/>
      <link href="../../stylesheets/desktop_theme_2_6707e7ee46ac9f2f0510c29ddd10e8f6ce21c1ae34fc.css?__ws=forum.moparisthebest.com" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2"/>
    
    
      <link rel="alternate" type="application/rss+xml" title="RSS feed of &#39;Ever Wanted to make your own scripting language?&#39;" href="51940.rss" />
  <meta property="og:site_name" content="moparisthebest.com" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:image" content="https://forum.moparisthebest.com/uploads/default/original/2X/4/41fecb6185fddc2758aeba68c3f8c9c78e26e4ff.png" />
<meta property="og:url" content="https://forum.moparisthebest.com/t/ever-wanted-to-make-your-own-scripting-language/51940" />
<meta name="twitter:url" content="https://forum.moparisthebest.com/t/ever-wanted-to-make-your-own-scripting-language/51940" />
<meta property="og:title" content="Ever Wanted to make your own scripting language?" />
<meta name="twitter:title" content="Ever Wanted to make your own scripting language?" />
<meta property="og:description" content="Taken off flipcode. üôÇ  Introduction  Okay. You want a scripting language for your engine. Why? Because they‚Äôre just really cool, and everybody has &#39;em these days.  First, decide what kind of scripting you want; Henry Robinson already wrote an introduction to the different kinds scripting (be sure to read it if you haven‚Äôt already). In this tutorial series, I‚Äôll be talking about a compiler / virtual machine system like UnrealScript.  Next, you need to know two things: how to implemen..." />
<meta name="twitter:description" content="Taken off flipcode. üôÇ  Introduction  Okay. You want a scripting language for your engine. Why? Because they‚Äôre just really cool, and everybody has &#39;em these days.  First, decide what kind of scripting you want; Henry Robinson already wrote an introduction to the different kinds scripting (be sure to read it if you haven‚Äôt already). In this tutorial series, I‚Äôll be talking about a compiler / virtual machine system like UnrealScript.  Next, you need to know two things: how to implemen..." />
<meta property="article:published_time" content="2007-01-26T17:00:00+00:00" />
<meta property="og:ignore_canonical" content="true" />



    
  </head>
  <body class="crawler">
    
    <header>
      <a href="../../index.html">
          <img src="../../uploads/default/original/2X/3/37bba8fb3bd06c372ab54fa72ec38bf9f8f40b37.gif" alt="moparisthebest.com" id="site-logo" style="max-width: 150px;">
      </a>
    </header>
    <div id="main-outlet" class="wrap">
      <h1 class="crawler-topic-title">
  <a href="51940.html">Ever Wanted to make your own scripting language?</a>
</h1>

<div id='breadcrumbs'>
    <div id="breadcrumb-0" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"
>
      <a href="../../c/general-programming.html" itemprop="url" class='badge-wrapper bullet'>
        <span class="badge-category-bg"></span>
        <span itemprop="title" class='category-title'>General Programming</span>
      </a>
    </div>
</div>





  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T17:00:00Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:25:57Z' class='post-time'>
              July 30, 2016,  4:25am
            </time>
        <span itemprop='position'>#1</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Taken off flipcode. <img src="../../images/emoji/twitter/slight_smile1bce.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p><span class="bbcode-b">Introduction</span></p>
<p>Okay. You want a scripting language for your engine. Why? Because they‚Äôre just really cool, and everybody has 'em these days.</p>
<p>First, decide what kind of scripting you want; Henry Robinson already wrote an introduction to the different kinds scripting (be sure to read it if you haven‚Äôt already). In this tutorial series, I‚Äôll be talking about a compiler / virtual machine system like UnrealScript.</p>
<p>Next, you need to know two things: how to implement such a scripting engine, and some reasons why a scripting engine is not only cool but actually useful.</p>
<p>Here‚Äôs what I made up:</p>
<h1>Useful new language features like states, latent code, etc.</h1>
<h1>A sandbox environment that can‚Äôt crash the game engine</h1>
<h1>Being able to create game content without knowledge of the engine internals and without having to recompile the engine</h1>
<h1>Fully platform-independent script code</h1>
<p>However, there are also drawbacks:</p>
<h1>Relatively slow - scripts run at least 15 times slower than executable code</h1>
<h1>Limiting - scripts can‚Äôt be used to create entirely new visual effects (partly because of the lack of speed).</h1>
<h1>People creating game content have to learn a new language</h1>
<p>Of course, we don‚Äôt let those stop us; we had already made up our minds. Now, where to start?</p>
<p>Required Reading</p>
<p>I started when Unreal hadn‚Äôt been released for very long. I was browsing their tech site and found the UnrealScript reference document. I had heard of UnrealScript of course, but didn‚Äôt really know what it was. I read the document and thought the idea of a script language was really cool. I wanted to write my own, and link it to a game engine so that the whole world could easily create new content for my game.</p>
<p>Fortunately, I got a class in Compiler Construction that semester, and as a practical assignment we had to implement a VERY simple Pascal compiler. I started working in parallel (OK, semi-parallel) on my own, better, compiler. I already had a ‚Äúworking‚Äù version which accepted a small subset of C, but I coded it in about 2 weeks, and the internal structure was pretty awful‚Ä¶ I had to completely redesign the whole thing. I‚Äôm sure you‚Äôve had a similar experience at some point in your life‚Ä¶ So I‚Äôm still working on this, and learning a lot about compilers while doing it.</p>
<p>But, let‚Äôs get to a little useful info.</p>
<p>First of all, I advise anyone who‚Äôs going to program a compiler to get the Dragon book. Most of you (especially CS students like me) probably know this one already. For those who don‚Äôt, I‚Äôm talking about Compilers - Principles, Techniques and Tools by Aho, Sethi and Ullman (ISBN 0-201-10194-7). It has a picture of a dragon on the front, hence the name ‚ÄúDragon book‚Äù. Believe me, anyone who knows anything about compilers has read this book.</p>
<p>The book hasn‚Äôt changed since 1986; this is because the underlying techniques of compiler design practically haven‚Äôt changed since the 1960‚Äôs. Of course, this book doesn‚Äôt cover processor-specific optimizations, but there are other books for that. Besides, we want to compile to bytecode, not machine code.</p>
<p>Second, if you‚Äôre looking for a quick overview of implementing a bytecode script language, check out this article on GamaSutra, which is a very readable story of how the Jedi Knight script language was implemented. I‚Äôll cover everything that‚Äôs in there too, but it‚Äôs still an interesting read.</p>
<p>What We Need</p>
<p>Basically a compiler consists of the following components:</p>
<h1>A symbol table, which contains all the symbols and information about type, scope, etc.</h1>
<h1>A lexical analyzer, which is a function that converts a character stream (i.e. the source file) into tokens (i.e. keywords, operators, etc.)</h1>
<h1>A parser, which takes the token stream and builds a syntax tree from it.</h1>
<h1>A semantic checker, which checks the syntax tree for semantic errors</h1>
<h1>An itermediate code generator, which converts the syntax tree into intermediate code</h1>
<h1>An optimizer (optional) which optimizes the intermediate code</h1>
<h1>A code generator, which generates bytecode from the intermediate code</h1>
<h1>Last but not least, the virtual machine on which the bytecode is to be executed.</h1>
<p>If you have programmed all these components, together they will form a complete scripting system.</p>
<p>Is That All?</p>
<p>Feeling a little overwhelmed? About to decide that maybe scripting isn‚Äôt so cool after all and DLL‚Äôs are really the only way to go? No need; I will be talking about each of the components in detail soon and most of them aren‚Äôt really that hard. Creating a complete scripting engine <em>is</em> a lot of work, though, and structuring your code is essential.</p>
<p>In the remaining parts of this tutorial we will develop a very simple compiler / virtual machine system. It will be nowhere near a full scripting language, but it will implement all the components listed above. I‚Äôm thinking about a simple language to manipulate strings.</p>
<p>For now, just check out the links and let the above sink in. All comments are greatly appreciated by the way!</p>
<p>Oh, I‚Äôve reinstated the quote at the end of tutorials (like Denthor used to do). Since I‚Äôm not funny enough to think of them myself, I will be quoting from some Wholly Remarkable Books. I‚Äôm sure you know which ones I‚Äôm talking about. If not, you should find out.</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>‚ÄúBut the plans were on display ‚Ä¶‚Äù<br>
‚ÄúOn display? I eventually had to go down to the cellar to find them.‚Äù<br>
‚ÄúThat‚Äôs the display department.‚Äù<br>
‚ÄúWith a torch.‚Äù<br>
‚ÄúAh, well the lights had probably gone.‚Äù<br>
‚ÄúSo had the stairs.‚Äù<br>
‚ÄúBut look, you found the notice didn‚Äôt you?‚Äù<br>
‚ÄúYes,‚Äù said Arthur, ‚Äúyes I did. It was on display in the bottom of a locked filing cabinet stuck in a disused lavatory with a sign on the door saying Beware of the Leopard.‚Äù</p>
<p>HHG 1:1<br>
[hr]</p>
<p>Introduction</p>
<p>I always say that examples can‚Äôt be simple enough when you‚Äôre learning something new. That‚Äôs why I‚Äôve tried to think of a very simple compiler that still has all the characteristics of a complete one. I came up with a string manipulation language that uses C-like syntax and has Basic-like functionality. Below is an example of a correct program in our language.</p>
<p>print "Please enter your name &gt; ";<br>
input name;<br>
if (name == ‚ÄúJan‚Äù)   {                    // string comparison<br>
name = ‚Äúmy creator‚Äù;                   // string assignment<br>
happy = ‚Äúyes‚Äù;<br>
}<br>
print "Thank you, " + name + ‚Äú!\n‚Äù +      // string concatenation<br>
‚ÄúYou‚Äôve just made a simple program very happy!‚Äù;</p>
<p>As you can see, there are no grouping structures like functions, classes, etc. and not even numeric types. The final product, however, will be easily expandable.</p>
<p>But before we get to that, we‚Äôve still got a long way to go - remember the list of components from last time? Today we‚Äôll implement the first one: the lexical analyzer, or lexer for short. It‚Äôll be a nice warm-up, since it‚Äôs not really a difficult part of the compiler.</p>
<p>Okay, ready to get analyzing?</p>
<p>What, Why and How</p>
<p>First, I guess you‚Äôd like to know what a lexical analyzer <em>is</em> and why we need it. The task of the lexical analyzer is to convert the character stream that is a source file into a token stream. Essentially it just looks at the characters sequentially and recognizes ‚Äúwords‚Äù in them.</p>
<p>We could of course write a function that compares the string at the current position in the source file to all our keywords, but that would be unbearably slow. Instead, we‚Äôll use a finite state machine to recognize words (if you don‚Äôt know what that is, don‚Äôt worry - you don‚Äôt need to).</p>
<p>The great thing about the lexer is that we don‚Äôt actually have to do any hard work - we let the lexer be generated by a program called ‚Äòlex‚Äô. This is a standard Unix program; there are also several Win32 implementations (The one I use is called Flex and it‚Äôs included in the zip file this part). For the complete Lex HTML manual, look here.</p>
<p>Well, you know what the lexer does and how we‚Äôre going to make it. Now would be a good time to download the tut2.zip file and have a look at the code. The source files for this part are string.l and main.cpp, plus a few header files. Note that the .zip file contains a directory structure that I‚Äôll use throughout this series; for example, flex.exe is located in the base dir and the files specific to this tutorial are in the tut2\ directory.</p>
<p>The Lexer Rules!!</p>
<p>Lex needs a few simple rules to be able to generate our lexer. Before I explain these rules, let‚Äôs study the layout of the Lex input file.</p>
 
 %%
 
 %%
 
<p>The section contains some regular expression macros (Regular expressions are explained in the Lex manual, and more thoroughly here. These tell Lex what we mean by a LETTER, a DIGIT, an IDENT (an identifier, which is defined as a letter followed by zero or more letters or digits) and a STR (a string constant, which is a string of characters enclosed in double quotes).</p>
<p>This section can also contain some initial code, like <span class="hashtag">#includes</span> for standard header files and forward references. This code should be put between the tags %{ and %}. I included the header file lexsymb.h here, which we‚Äôll look at in a minute.</p>
<p>The section can contain any code you need for analyzing; in our case it contains a function to skip all characters inside comment, functions to pass the identifier name and contents of string constants to the caller, and our main function.</p>
<p>The lexsymb.h file contains the declarations of the token symbols the lexer function will return. It also contains the declaration of a union ‚Äòyylval‚Äô used to pass extra information (like the name of an identifier) to the caller; why we‚Äôre using this specific union will become clear in the next part.</p>
<p>Now, let‚Äôs look at the actual rules. Note that I‚Äôm using /* */ comment; Lex is an old program and doesn‚Äôt support // comment in its input files. We will produce a C lexer by the way - C++ versions of Lex are available but the standard Unix Lex produces C code, and we want to keep things portable, don‚Äôt we?</p>
<p>‚Äúif‚Äù     {return IF;}<br>
‚Äú=‚Äù      {return ASSIGN;}<br>
‚Äú;‚Äù      {return END_STMT;}<br>
{IDENT}  {Identifier ();             /* identifier: copy name <em>/<br>
return ID;}<br>
{STR}    {StringConstant ();         /</em> string constant: copy contents <em>/<br>
return STRING;}<br>
‚Äú//‚Äù     {EatComment();}             /</em> comment:    skip <em>/<br>
\n       {lineno++;}                 /</em> newline:    count lines <em>/<br>
{WSPACE} {}                          /</em> whitespace: (do nothing) <em>/<br>
.        {return ERROR_TOKEN;}       /</em> other char: error, illegal token */</p>
<p>I left out some rules that were very similar. As you can see, each rule starts with the pattern Lex should recognize, followed by some code telling Lex what to do (this code <em>can</em> contain C++ by the way, because Lex just copies it into the output file). Note that the topmost rules are evaluated first; this is sometimes important.</p>
<p>The first three rules are very simple; they just recognize a string of characters and return the appropriate token symbol to the caller. Note that you can just change the strings if you want ‚Äú:=‚Äù to be the assignment operator, for example.</p>
<p>The fourth line is the first ‚Äúinteresting‚Äù one: it makes use of the IDENT macro, so it recognizes a string of characters/digits that doesn‚Äôt satisfy any of the previous rules. If found, it calls the Identifier() function, which copies the string from yytext (which contains the text for the current token) into a new char array. The lexer then returns the ID token; the caller can just look at the ‚Äòyylval-&gt;str‚Äô pointer to find the name of the identifier. STR does the same for a string constant.</p>
<p>The next lines takes care of comment, newlines and whitespace. Note that the line number is counted; we‚Äôll use this for error messages in the future. The final rule tells Lex that if the input doesn‚Äôt satisfy any of the above rules (the regular expression ‚Äú.‚Äù means: any char except ‚Äò\n‚Äô), we should return an error token and let the caller decide what to do.</p>
<p>This Lex input file can be compiled to lex.cpp to using the command:</p>
<p>flex -olex.cpp string.l</p>
<p>Also included in the .zip archive is a project file for MSVC 6.0 (string.dsp). I believe it also works with 5.0, but I‚Äôm not sure. This project file contains a custom build command for string.l so it compiles automatically.</p>
<p>Unfortunately, lex uses a non-standard include file, unistd.h, which is not available on Windows systems. In the base dir is an empty unistd.h file; include the base dir in your include files path (in MSVC: Tools-&gt;Options-&gt;Directories-&gt;Include).</p>
<p>The file lex.cpp contains a complete lexer that satisfies our rules. It‚Äôs that simple! The main program in this example just reads a token using the lexer function and shows the token name and value (if it‚Äôs ID or STR). You can try typing some stuff and see what the lexer makes of it; random characters will generally be seen as ID‚Äôs, but other unused chars like ‚Äò$‚Äô will cause an ERROR_TOKEN. You can try example.str (in the base directory) too!</p>
<p>It Gets Better, Really</p>
<p>Well, now we have a program that can ‚Äúread‚Äù. Unfortunately, it still has no idea what it‚Äôs reading and whether this is correct by our standards. It will just accept any token it knows about.</p>
<p>So it has to learn about grammar. By an amazing coincidence, grammar is exactly what the next part is about. The next component is called the parser and its task is to find out the structure of the program and check the syntax while it‚Äôs at it.</p>
<p>Then things really get interesting. We will actually be able to feed the program from the introduction to the compiler and it will accept it - not because it accepts just about anything, but because it knows the program is syntactically correct! I just know you‚Äôre as wildly excited about this as I am, but you‚Äôll have to wait until the next part‚Ä¶</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>"And so it was only with the advent of pocket computers that the startling truth became finally apparent, and it was this:</p>
<p>Numbers written on restaurant bills within the confines of restaurants do not follow the same mathematical laws as numbers written on any other pieces of paper in any other parts of the Universe.</p>
<p>This single fact took the scientific world by storm. It completely revolutionized it. So many mathematical conferences got held in such good restaurants that many of the finest minds of a generation died of obesity and heart failure and the science of maths was put back by years."</p>
<p>HHG 2:7<br>
[hr]</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T17:01:47Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:25:57Z' class='post-time'>
              July 30, 2016,  4:25am
            </time>
        <span itemprop='position'>#2</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Introduction</p>
<p>The executable from the previous part did a nice job converting programs to tokens. All keywords, operators, punctuators, identifiers and constants were immediately recognized and reported. However, you could type</p>
<p>{ this ) = ‚Äúpointless‚Äù + ;</p>
<p>and the program would just accept it and happily produce a list of tokens. Since this is clearly not something we want to allow (I have no idea what the above ‚Äòstatement‚Äô should do), we have to be able to recognize syntax structures (or lack thereof) in the input program.</p>
<p>We do this by means of the parser, which finds the structure of the program and checks for any syntax errors.</p>
<p>A Little Language Theory</p>
<p>How can we tell the parser what our language looks like? Well, we can use a way of specifying syntax (or ‚Äúgrammar‚Äù) called Backus-Naur Form (BNF). This method of specification uses the basic concepts that a program is made up of. For example, expressions can be, among other things, identifiers or string constants. In BNF, this is written as follows:</p>
<p>expression: identifier | string;</p>
<p>A statement can be a print or an input statement:</p>
<p>statement<br>
: PRINT expression END_STMT<br>
| INPUT identifier END_STMT<br>
;</p>
<p>(remember that PRINT, INPUT and END_STMT were tokens returned by our lexer)</p>
<p>Now, a program can be expressed as being a list of statements in the following way:</p>
<p>program: | program statement;</p>
<p>which says that a program is either empty or a program followed by one statement, which is a nice recursive definition of a list of statements.</p>
<p>So, the language we‚Äôve defined in BNF includes the statements:</p>
<p>print a;<br>
print ‚ÄúHello‚Äù;<br>
input name;</p>
<p>Not legal is:</p>
<p>input ‚ÄúHello‚Äù;</p>
<p>because we‚Äôve defined the input statement so it can only take an identifier, not a string constant.</p>
<p>With the use of BNF, we can formally specify the whole syntax of our language. Note that this does not include semantics yet, so the statement</p>
<p>a = (b == c);</p>
<p>will be accepted by the parser even though it doesn‚Äôt make sense (we‚Äôre trying to assign a boolean value to a string variable). Semantics are checked at a later stage.</p>
<p>Great, we now know enough about language specifications to create our parser!</p>
<p>Looks Familiar!</p>
<p>The parser is also generated using an external program. This one is called Yacc (a standard Unix tool, just like Lex); we‚Äôll be using an improved version called Bison (get it?). The Bison manual can again be found here.</p>
<p>The layout of a Yacc file (extension .y) is in fact very similar to that of a Lex file:</p>
 
 %%
 
 %%
 
<p>The section contains token definitions, type information, and the definition of the yylval union we saw in the previous part. That‚Äôs why we used a union: Yacc uses this same union to pass information between the different ‚Äòlanguage concepts‚Äô like expression, statement, and program. From these definitions, Yacc generates the lexsymb.h file for us (actually it creates parse.cpp.h but the parser.bat procedure renames it).</p>
<p>Again, just like a Lex file, this section may contain some initial code between the tags %{ and %}. The section is not yet used in this part, but can also contain any additional code you need.</p>
<p>The rules are specified in Backus-Naur Form as explained in the previous section.</p>
<p>There is a nasty catch to using Yacc, though, and it‚Äôs that your language specification has to be LR(1)‚Ä¶ What exactly that means is explained extensively in the Dragon book (section 4.5 about bottom-up parsing), but basically the parser has to be able to tell what kind of syntax rule to use by looking at the current lexer token and not more than ONE token ahead. The following rule would generate a shift/reduce conflict:</p>
<p>A:<br>
| B C<br>
| B C D<br>
| D E F<br>
;</p>
<p>The conflict would not arise when reading ‚ÄòB‚Äô from the input file and looking ahead to ‚ÄòC‚Äô as you may think, because these can be grouped (both of these alternatives will generate an A symbol eventually); the problem is that the second alternative ends with ‚ÄòD‚Äô, and the third begins with it: when the parser has read ‚ÄòC‚Äô and looks ahead to ‚ÄòD‚Äô, it can‚Äôt decide whether to classify this as A2 or as A1 followed by a A3! So although the complete syntax definition may not be ambiguous at all, to the parser it <em>is</em> because it can only look ahead ONE token. Yacc will call this semi-ambiguity a shift/reduce or reduce/reduce conflict.</p>
<p>Well, don‚Äôt let all of that scare you. Have a look at the rules. The most important one is perhaps the statement rule:</p>
<p>statement<br>
: END_STMT                    {puts (‚ÄúEmpty statement‚Äù);}<br>
| expression END_STMT         {puts (‚ÄúExpression statement‚Äù);}<br>
| PRINT expression END_STMT   {puts (‚ÄúPrint statement‚Äù);}<br>
| INPUT identifier END_STMT   {puts (‚ÄúInput statement‚Äù);}<br>
| if_statement                {puts (‚ÄúIf statement‚Äù);}<br>
| compound_statement          {puts (‚ÄúCompound statement‚Äù);}<br>
| error END_STMT              {puts (‚ÄúError statement‚Äù);}</p>
<p>As you can see, this defines all the types of statements our language has, with code next to it telling the parser what to do when it finds each alternative. I think this rule is pretty straightforward. One thing though: the ‚ÄúError statement‚Äù tells Yacc what to do if it encounters a parse error (such as an illegal token or an non-fitting token) while parsing a statement. In this case it will look for the next END_STMT token and continue parsing after that. Parse errors are always reported to the yyerror() function defined in main.cpp so our compiler can deal with it in an appropriate way. If you don‚Äôt supply an error rule anywhere in your .y file, your parser will stop when it finds a parsing error, which isn‚Äôt very graceful.</p>
<p>Perhaps you‚Äôre wondering why there are so many different expression rules: expression, equal_expression, assign_expression, concat_expression and simple_expression. This is to specify the precedence of the operators. If the parser sees this:</p>
<p>if (a == b + c)</p>
<p>it should know it shouldn‚Äôt evaluate a==b and then try to add the boolean result of this to the string variable c. The different expression rules make sure there‚Äôs only one way to parse this statement. Just look at it for a while; it works.</p>
<p>Another problem is parsing the following statement:</p>
<p>if (a == b)   if (c == d)   e = f;   else g = h;</p>
<p>The parser doesn‚Äôt know to which if-statement (the inner or outer if) the else belongs; it could think you meant</p>
<p>if (a == b)   {if (c == d)   e = f;}   else g = h;</p>
<p>but the convention in all imperative languages is to group the else with the inner if.</p>
<p>Since there is no way to solve this by changing your rules, Yacc would report a shift/reduce conflict. This conflict is simply suppressed by adding the line</p>
<p>%expect 1</p>
<p>to the definitions section, meaning Yacc should expect 1 conflict. Yacc will ‚Äúsolve‚Äù this conflict by associating the else with the nearest if, just like we want. That‚Äôs just the default solution to any conflicts it finds.</p>
<p>The rest of the Yacc file is pretty self-explanatory once you understand BNF. If there‚Äôs anything left that‚Äôs unclear, you can always mail me about it or post a question on the messageboard.</p>
<p>This Yacc input file can be compiled using the command:</p>
<p>bison --defines --verbose -o parse.cpp</p>
<p>If you get any conflicts, look at the file parse.cpp.output which contains details about the conflict (even if you don‚Äôt get errors it‚Äôs an interesting file to look at). If you run into any conflicts you can‚Äôt solve, just send me your .y file and I‚Äôll have a look at it.</p>
<p>If everything went OK (it should do so with the sample code) you get a working lexer in the file parse.cpp. All our new main program does is call the yyparse() function and the whole input file will be sliced &amp; diced for us!</p>
<p>Try example.str again and watch the error it produces. Error? Yes, that‚Äôs right, I forgot one ‚Äò;‚Äô at the end of line 13. But hey, it works! Great huh?</p>
<p>Whew!</p>
<p>That was quite a lot we did today. We learned some formal language theory, how to use it in Yacc, why Yacc is so picky about which grammars it supports, and how to specificy operator precedence. And finally, we made a working parser!</p>
<p>Well, I think the hardest part is actually behind us. If you understand this, the rest will be a piece of cake. However, if I‚Äôve lost you somewhere while ranting about LR(1) grammars, post on the messageboard or mail me so I can try to clarify things! Any other questions or comments are also welcome, if only so I know people are actually reading this stuff (okay, I believe Kurt at least skims over it while converting to HTML <img src="../../images/emoji/twitter/wink1bce.png?v=6" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Now, what lies in the future? Next time we‚Äôll probably write TWO new components: the symbol table and the syntax tree. Until then, you have a week to experiment with the code. Tip: try to get the compiler to accept C-style while statements!</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>‚ÄúThe major problem is quite simply one of grammar, and the main work to consult in this matter is Dr Dan Streetmentioner‚Äôs Time Traveller‚Äôs Handbook of 1001 Tense Formations. It will tell you for instance how to describe something that was about to happen to you in the past before you avoided it by time-jumping forward two days in order to avoid it. The event will be described differently according to whether you are talking about it from the standpoint of your own natural time, from a time in the further future, or a time in the further past and is further complicated by the possibility of conducting conversations whilst you are actually travelling from one time to another with the intention of becoming your own father or mother.‚Äù</p>
<p>HHG 2:18 [br][size=1]Posted on: January 25, 2007, 10:00:26 PM[/size][hr]Introduction</p>
<p>If we are to do something useful with the lexer and parser we created in the last two parts, we need to store the information we can gather from the program in data structures. This is what we‚Äôre going to do next. Two important components are involved in this: the symbol table and the syntax tree.</p>
<p>The symbol table is, like the name suggests, a table that contains all symbols used in our program; in our case, all the string variables, and the constant strings too. If your language includes functions and classes, their symbols would be stored in the symbol table too.</p>
<p>The syntax tree is a tree representation of the program structure; see the picture below for the idea. We use this representation in the next part to generate intermediate code. Although it is not strictly necessary to actually build the syntax tree (we already have all the information about program structure from the parser), I think it makes the compiler more tranparent, and that‚Äôs what I‚Äôm aiming for in this series.</p>
<p>This is the first part that includes ‚Äòreal‚Äô code, and before you look at it, I‚Äôd like to make it clear that this code was written to be easily understandable rather than well-structured. It will suffice for the compiler we‚Äôre making here, but in a real-world script compiler you‚Äôll want to do a lot of things differently. I‚Äôll try to mention these things as we come across them.</p>
<p>Passing Information Between Rules</p>
<p>Obviously, we have to add functionality to our parser; particularly, when we find a symbol we enter it into the symbol table ‚Äì but we also want the ‚Äúparent‚Äù rule (the rule that actually uses the identifier) to have access to the symbol description.</p>
<p>Something similar is required when we‚Äôre building a syntax tree: we want the parent rule to have a pointer to the nodes of his ‚Äòchild rules‚Äô (the rules the parent rule is constructed of).</p>
<p>Well, remember the yylval union? Yacc uses this to pass information between the rules, too. Every rule can have an associated field in the yylval union; this is the rule‚Äôs type. At the top of string.y you can see type declarations like the following:</p>
<p>%type  identifier string<br>
%type   statement expression</p>
<p>symbol and tnode are new members of the union; they represent a pointer to a symbol description and a pointer to a syntax tree node, respectively.</p>
<p>Now the statement rule uses these types as follows:</p>
<pre><code>  | expression END_STMT     {$$ = new TreeNode (EXPR_STMT, $1);} 
</code></pre>
<p>This means: if you find an expression statement, construct a new tree node (and ‚Äòreturn‚Äô the node pointer) of type EXPR_STMT with one child: the expression that the statement is composed of. So $$ represents the ‚Äòreturn value‚Äô of a rule, and $1 is the value returned by the first symbol in the rule definition (expression). $2 has no meaning here, because the lexer doesn‚Äôt set an yylval-member for the token END_STMT.</p>
<p>I hope this explanation is clear enough, because it is important. Essentially, the rules form a hierarchy and every rule can return a value to a ‚Äòhigher‚Äô rule.</p>
<p>Now let‚Äôs see what data structures we use for the symbol table and the syntax tree.</p>
<p>The Symbol Table</p>
<p>The symbol table in our example contains very little information; basically it‚Äôs only the name of the variable and the line in which it was first declared. We will use it to store more data later on, though.</p>
<p>The implementation is very simplistic: it just builds a singly-linked list of symbol descriptions and searches this list linearly when we retrieve a symbol (have a look at the symtab.cpp, it‚Äôs really straightforward). For a real compiler, the symbol table is usually implemented as a binary search tree or a hash table, so symbols can be looked up much faster.</p>
<p>All we need to do to enter our symbols into the table when the parser finds them is this:</p>
<p>identifier<br>
: ID<br>
{<br>
$$ = st.Find ($1);<br>
if ($$ == NULL)   { // doesn‚Äôt exist yet; create it<br>
$$ = new SymDesc ($1, STR_VAR, NULL, lineno);<br>
st.Add ($$);<br>
}<br>
}<br>
;</p>
<p>We treat string constants as constant variables, so we generate a name for them and also enter them into the table.</p>
<p>Note that a more advanced compiler would probably let the lexer store and retrieve identifiers. This is because in a complex language there are many different meanings identifiers can have: variables, functions, types, etc. The lexer could retrieve the identifier description and directly return the appropriate token to the parser. Since our identifiers are always variables, I just let the parser handle them.</p>
<p>The Syntax Tree</p>
<p>For the syntax tree I have created a very simple TreeNode class. It just stores pointers to children and some additional information (the node type and a link to a symbol if applicable). Have a look, there‚Äôs nothing complicated going on in there.</p>
<p>As you saw before, we can easily build our syntax tree from the recognized parser rules:</p>
<p>equal_expression<br>
: expression EQUAL assign_expression   {$$ = newTreeNode(EQUAL_EXPR, $1, $3);}<br>
| assign_expression                    {$$ = $1;}<br>
;</p>
<p>You can see that we sometimes just pass the information from a child rule on to our parent rule unchanged; if your equal_expression is actually just an assign_expression, there‚Äôs no point in making an extra node for it; you just use the one created in assign_expression. Remember that the only reason we created so many expression rules was to unambiguously handle operator precedence.</p>
<p>Compilation of this part (and the following parts) is the same as for the previous parts. The program still accepts syntactically correct programs, but now shows a dump of the symbol table and syntax tree it has built.</p>
<p>That‚Äôs Pretty Cool, But‚Ä¶</p>
<p>Okay, so it reads the program and it analyzes it. But it doesn‚Äôt really do anything smart or useful with it, does it?</p>
<p>Well, no. Not yet. We still have some more components to implement. The next part will cover semantic checking and intermediate code generation. Those will take us a long way towards a compiled program.</p>
<p>I hope you don‚Äôt think it‚Äôs going too slow, but I want to focus on each component separately, not just rush through things. If you understand all this stuff immediately, be happy with that and experiment!</p>
<p>See you next time.</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>(Part of the Guide entry on the Babel Fish)</p>
<p>"Now it is such a bizarrely improbable coincidence that anything so mindboggingly useful could have evolved purely by chance that some thinkers have chosen to see it as the final and clinching proof of the non-existence of God.</p>
<p>The argument goes something like this: <code>I refuse to prove that I exist,' says God,</code>for proof denies faith, and without faith I am nothing.‚Äô</p>
<p><code>But,' says Man,</code>The Babel fish is a dead giveaway, isn‚Äôt it? It could not have evolved by chance. It proves you exist, and so therefore, by your own arguments, you don‚Äôt. QED.‚Äô"</p>
<p>HHG 1:6</p>
<p>Downloads</p>
<p>Download the tutorial code (tut4.zip) (8k) [<a href="http://www.flipcode.com/articles/tut4.zip" rel="nofollow noopener">http://www.flipcode.com/articles/tut4.zip</a></p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T17:03:09Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:25:58Z' class='post-time'>
              July 30, 2016,  4:25am
            </time>
        <span itemprop='position'>#3</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Introduction</p>
<p>A little late this time‚Ä¶ Exams are horrible things, they really interfere with useful stuff.</p>
<p>Right, last time I promised results and you‚Äôre gonna get 'em. More than you wished for, probably ;-).</p>
<p>But first a general remark about these tutorials. I have a tendency to write very compact explanations. The information is all there, but often there are two important facts per sentence‚Ä¶ The disadvantage of this is that if something is not clear, you probably can‚Äôt follow the rest of the tutorial. Please tell me when I‚Äôm going too fast so I can clear things up.</p>
<p>Back to this part. It‚Äôs about semantics and intermediate code. Checking the semantics will make sure that our program is really correct, and the intermediate code will be a giant leap towards a virtual executable.</p>
<p>Let‚Äôs get checking!</p>
<p>Checking the Semantics</p>
<p>Semantic checking is done to make sure that not only the syntax of the program is correct, but the statements also make sense. The number of parameters supplied to a function, for example, should be the number this function expects.</p>
<p>The major part of semantic checking is type checking: determining the types of expressions and reporting any inconsistencies, like trying to compare a boolean to a string or passing the wrong type of argument to a function.</p>
<p>Of course you may want to allow some of these ‚Äòinconsistencies‚Äô; for example when someone uses the following statement</p>
<p>print "a and b equal: " + (a == b);</p>
<p>he probably means that the expression (a == b) should be converted to a string automatically, resulting in the string ‚Äútrue‚Äù or ‚Äúfalse‚Äù. This is called a coercion. In our sample compiler I‚Äôve only allowed bool to string coercion, but you could easily add string to bool coercion if you think that‚Äôs useful.</p>
<p>The code for our semantic checker is not complicated. I‚Äôve added a member function to TreeNode called Check() (in synttree.cpp) that checks a node‚Äôs semantics, assuming that all its children have already been checked. Check() is automatically called from the TreeNode constructors, so that‚Äôs a safe assumption.</p>
<p>Check sets a new member variable called rettype, the ‚Äòreturn type‚Äô of the expression. A condition, for example, has boolean as its return type, while a string concatenation returns another string. Rettype is used to check the semantics of the parent node. The function CoerceToString is used to coerce any expression to string type (if it isn‚Äôt already) by inserting a new node, COERCE_TO_STR, as the new parent of the node to be coerced.</p>
<p>For a simple compiler this is easy, but generally it‚Äôs not. If your language includes more base types, references, arrays, classes and (operator) overloading things get ugly real fast; you‚Äôd better have a solid type checking system if you ever want your program to run.</p>
<p>In a real compiler a lot of the work goes into this: there are more coercions, you have to figure out which of the overloaded functions must be used, type equivalence isn‚Äôt so trivial anymore, etc.</p>
<p>So yes, in this case it‚Äôs simple, and it‚Äôs a useful learning experience to try to expand this system with some more types, but at some point you‚Äôll want to take a more general approach.</p>
<p>The rest of the code pretty much explains itself. It just enforces simple things like: if-conditions should be boolean, assignment expressions should be strings, etc.</p>
<p>Generating Intermediate Code</p>
<p>Intermediate code is a sort of graph representation of your program: every instruction has a pointer to the next instruction, and jumps have a pointer to their target instructions.</p>
<p>I can think of two advantages of doing it this way (with pointers) instead of immediately generating code into a big array. First, because of the pointer-representation, it‚Äôs easy to concatenate pieces of code together, and even cutting some instructions can be done without having to update all the jumps, etc. So optimization is relatively easy to do. Second, if you want to change some instructions on your virtual machine it‚Äôs easier to adapt your compiler to the new VM because you only have to change the translation step from intermediate to final code, which is relatively easy.</p>
<p>So, with all that in mind, we design our intermediate code language. The opcodes in this language will be very similar if not identical to the ones our virtual machine will execute. Have a look at them:</p>
<p>enum Opcode  {<br>
OP_NOP,           // no operation<br>
OP_PUSH,          // push string [var]<br>
OP_GETTOP,        // get string from top of stack (=assign) [var]<br>
OP_DISCARD,       // discard top value from the stack<br>
OP_PRINT,         // print a string<br>
OP_INPUT,         // input a string [var]<br>
OP_JMP,           // unconditional jump [dest]<br>
OP_JMPF,          // jump if false [dest]<br>
OP_STR_EQUAL,     // test whether two strings are equal<br>
OP_BOOL_EQUAL,    // test whether two bools are equal<br>
OP_CONCAT,        // concatenate two strings<br>
OP_BOOL2STR,      // convert bool to string<br>
JUMPTARGET        // not an opcode but a jump target;<br>
// the target field points to the jump instruction<br>
};</p>
<p>You can see our VM is going to be a stack machine: opcodes will operate on values from the stack and will put values back on the stack. I think this is the simplest type of machine, both to generate code for and to execute code on.</p>
<p>One note about the JUMPTARGET ‚Äúopcode‚Äù: whenever we have a (conditional) jump in our code, it points not to the actual target instruction, but to a prefixed ‚ÄúJUMPTARGET‚Äù instruction. The reason for this is that when we optimize we have to know every jump target point in the code, or we might optimize a target instruction away and mess up our program. The JUMPTARGETs won‚Äôt be in our final bytecode.</p>
<p>In general, all opcodes operate on items on top of the stack. So OP_STR_EQUAL pops the top two items off the stack (these must be strings), checks if they‚Äôre equal, and pushes the resulting boolean on the stack. Your program can then use the OP_JMPF instruction to react to that result: it jumps to the target instruction (which IS supplied with the instruction, not on the stack) if the boolean on top of the stack is false and continues execution is it‚Äôs true.</p>
<p>The instructions are stored in a very simple intermediate instruction class, which just stores the opcode, a ‚Äòsymbol‚Äô-operand (e.g. for OP_INPUT) and a jump target instruction if applicable, a next instruction pointer and a line number. The line number is actually just so we can make the code human-readable with the Show() function.</p>
<p>Now, let‚Äôs look at how we generate the intermediate code (intcode.cpp). Generally we just recursively generate code for all subtrees in the syntax tree. So main calls the GenIntCode() function with the root of the tree; GenIntCode then takes care of the rest and returns a pointer to the beginning of the intermediate code.</p>
<p>First a simple case, the INPUT_STMT node:</p>
<p>case INPUT_STMT:<br>
return new IntInstr (OP_INPUT, root-&gt;symbol);</p>
<p>This just generates a new OP_INPUT instruction and returns it. Note that this instruction is also a ‚Äúblock of instructions‚Äù of length 1 (the next pointer is set to NULL by default).</p>
<p>The PRINT_STMT is a little harder:</p>
<p>case PRINT_STMT:<br>
blk1 = GenIntCode (root-&gt;child[0]);<br>
blk2 = new IntInstr (OP_PRINT);<br>
return Concatenate (blk1, blk2);</p>
<p>First we generate the code that evaluates the expression supplied to the print statement (root-&gt;child[0]). Then we create a new instruction OP_PRINT that prints the string on top of the stack. Note that we assume the expression leaves its value on top of the stack. We‚Äôll have to make sure of this ourselves, of course. Finally we concatenate the two block of instructions and return the result.</p>
<p>Now a really hard one: the IFTHEN_STMT. I just generate the blocks needed for this, and then concatenate them all together. The approach is to check the condition, jump to the end if it‚Äôs false, and execute the then-part if it‚Äôs true.</p>
<p>case IFTHEN_STMT:<br>
// First, create the necessary code parts<br>
cond      = GenIntCode (root-&gt;child[0]);<br>
jump2end  = new IntInstr (OP_JMPF);      // set target below<br>
thenpart  = GenIntCode (root-&gt;child[1]);<br>
endif     = new IntInstr (JUMPTARGET, jump2end);<br>
jump2end-&gt;target = endif;</p>
<p>// Now, concatenate them all<br>
Concatenate (cond, jump2end);<br>
Concatenate (jump2end, thenpart);<br>
Concatenate (thenpart, endif);<br>
return cond;</p>
<p>Remember that root-&gt;child[0] is the condition-subtree and root-&gt;child[1] the then-subtree.</p>
<p>Well, if that was understandable, you won‚Äôt have a problem with the rest of the code. All tree nodes are translated in this way. The Show() function just shows the code we‚Äôve generated. Have a look at what all this does:</p>
<p>Program:<br>
if (a==b)  a; else b;</p>
<p>Intermediate code:<br>
1: OP_NOP<br>
2: OP_PUSH a<br>
3: OP_PUSH b<br>
4: OP_STR_EQUAL<br>
5: OP_JMPF 9<br>
6: OP_PUSH a<br>
7: OP_DISCARD<br>
8: OP_JMP 12<br>
9: JUMPTARGET 5<br>
10: OP_PUSH b<br>
11: OP_DISCARD<br>
12: JUMPTARGET 8</p>
<p>That looks an awful lot like assembly code, doesn‚Äôt it? Well, that‚Äôs because it is. It‚Äôs Virtual Assembly, and essentially we only need to write an assembler program to generate a Virtual Executable.</p>
<p>Whoa, what happened?</p>
<p>That went fast, didn‚Äôt it? One moment we‚Äôre wondering if we‚Äôre ever going to do something interesting, and suddenly we have generated virtual assembly code! We‚Äôre almost done!</p>
<p>Well, not quite. Next time we‚Äôre gonna look at some optimizations (I‚Äôm sure you can think of some if you look at the some of the output from this part). And soon, we‚Äôll produce actual virtual machine code - but I guess we‚Äôd better have a virtual machine first! We‚Äôll see where we go from there. You‚Äôre welcome to send me any ideas or suggestions about what direction to explore.</p>
<p>Bottom line: some interesting stuff is coming up. Stay tuned!</p>
<p>See you next time.</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>The story so far:</p>
<p>In the beginning the Universe was created.</p>
<p>This has made a lot of people very angry and been widely regarded as a bad move.</p>
<p>HHG 2:1</p>
<p>Downloads</p>
<p>Download the tutorial code (tut5.zip) (10k) [<a href="http://www.flipcode.com/articles/tut5.zip" rel="nofollow noopener">http://www.flipcode.com/articles/tut5.zip</a>]</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>

          <div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
          </div>

  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T17:04:43Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:25:58Z' class='post-time'>
              July 30, 2016,  4:25am
            </time>
        <span itemprop='position'>#4</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Did you Spot The Bug?</p>
<p>Noticed anything funny about the code of the last two parts? A memory leak maybe? Emmanuel Astier did; he found a bug in the symbol table: when deleting the symbol table, I only delete the first entry in the linked list, not the others‚Ä¶ Okay, so the program doesn‚Äôt crash, but it ain‚Äôt pretty. This will be fixed in the next tutorial. Thanks Emmanuel!</p>
<p>Introduction</p>
<p>Well, my exams are done so I can finally continue the tutorial!</p>
<p>In this part I‚Äôll cover ways to optimize our intermediate code. Remember that we‚Äôre using a very simple code generation algorithm so the code can probably be optimized quite a bit.</p>
<p>Because we‚Äôre executing on a virtual machine, optimization becomes extra important: each of our instructions will take at least 20 CPU instructions to execute (it‚Äôs very hard to get below that) so the fewer instructions, the better.</p>
<p>Note that I‚Äôll only be talking about machine-independent optimizations; machine-dependent optimization is a very different topic altogether, where you have to consider things like pipelining efficiency, register usage, etc. And of course, machine-dependent optimizations for your code are only needed if you actually run on hardware, which we won‚Äôt. Of course there may be lots of ways to speed up execution of the virtual machine itself, but we‚Äôll see to that later.</p>
<p>Sorry, there‚Äôs no example code for this part. Some of the optimization ideas are quite easy to implement, so you‚Äôll have no trouble with those. Others are more complex and require quite a lot of work to implement. I don‚Äôt have the time to do this so I‚Äôll just give the general idea.</p>
<p>There are two important ways we can speed up our code. One way is to translate the code so it uses less instructions. Another is to make more powerful instructions.</p>
<p>Extra Opcodes</p>
<p>Higher-level instructions tend to be relatively fast to execute on a VM since the overhead from stack manipulation and instruction pointer updating is still (roughly) the same while we do more work. So we‚Äôre going to forget RISC and go crazy with exotic instructions! <img src="../../images/emoji/twitter/wink1bce.png?v=6" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Let‚Äôs look at some code. This is part of example.vasm, the compiled version of example.str:</p>
<p>1: OP_NOP<br>
2: OP_PUSH strconst1<br>
3: OP_GETTOP a<br>
4: OP_DISCARD<br>
5: OP_PUSH strconst2<br>
6: OP_GETTOP b<br>
7: OP_DISCARD<br>
8: OP_PUSH a<br>
9: OP_PUSH b<br>
10: OP_CONCAT<br>
11: OP_GETTOP s<br>
12: OP_DISCARD<br>
13: OP_PUSH s<br>
14: OP_PRINT</p>
<p>I noticed a few things about this. First, at three places in the code there‚Äôs an OP_DISCARD following an OP_GETTOP. We could speed this up by converting it to one OP_POP opcode that gets the top value and removes it from the stack. I could‚Äôve done this in the first place, but I thought this was easier.</p>
<p>Second, I see OP_PUSH; OP_GETTOP; OP_DISCARD twice‚Ä¶ That‚Äôs the code for simple assignments like ‚Äúa = b;‚Äù. We could provide a special opcode OP_COPY for this that copies the value of one variable to another.</p>
<p>Third, in the complete code for this program there are quite a few ‚Äúdouble pushes‚Äù: two pushes following each other. We could make a separate opcode OP_PUSH2 to speed this up.</p>
<p>You can probably think of other high-level instructions to add. For example, a OP_CONCATTO opcode to concatenate to an existing string (s += ‚Äúfoo‚Äù;). If you pick these carefully they can really speed up execution, so take the time to study your assembly code and find optimization candidates.</p>
<p>Code Transformations</p>
<p>Another way of optimizing output code is to transform some part of the code to something that does the same thing faster. An example of this:</p>
<p>Source 	Assembly 	Optimized<br>
s = a;<br>
if (s == d) ‚Ä¶ 	OP_PUSH a<br>
OP_GETTOP s<br>
OP_DISCARD<br>
OP_PUSH s<br>
OP_PUSH d<br>
OP_STR_EQUAL<br>
‚Ä¶ 	<br>
OP_PUSH a<br>
OP_GETTOP s<br>
(cut away)<br>
(cut away)<br>
OP_PUSH d<br>
OP_STR_EQUAL<br>
‚Ä¶</p>
<p>Below are some established algorithms to tranform your code, saving instructions and thus time.</p>
<p>Most optimizations concentrate on optimizing little pieces of code known as ‚Äúbasic blocks‚Äù. A basic block is has the following properties: you can only jump into it at the beginning and you can only jump out of it at the end. So there are no jumps or jump targets in the middle of the block. This means that within the block we can be sure of certain things about the value of our variables and can use this information to optimize the code. For example, if you could just jump to somewhere inside the block we could never be sure that, at that point, t still has the value (a * b - c).</p>
<p>Pointers make basic block optimizations a lot harder, since you have to be sure that a variable isn‚Äôt modified through a pointer instead of through its name somewhere inside the basic block. Sometimes you just can‚Äôt be sure about this (with pointer to pointers it‚Äôs almost impossible to know what variable is changed) and you just have to skip an optimization step that may have been valid.</p>
<p>Algebraic identities A simple way of optimizing code is to replace ‚Äònaive‚Äô calculations with faster versions that produce the same result. Note that these naive calculations are usually introduced by a simple code generation scheme rather than explicitly by the programmer. Have a look at the table, these are pretty obvious.</p>
<p>Before 	After<br>
x + 0<br>
x * 1<br>
x ** 2<br>
2.0 * x<br>
x / 2</p>
<p>x<br>
x<br>
x * x<br>
x + x<br>
x * 0.5</p>
<p>Common subexpression elimination This optimization takes advantage of the fact that a certain expression may be used several times in a small piece of code:</p>
<p>a = a + (b - 1);<br>
c = c + (b - 1);</p>
<p>Here, (b - 1) is a common subexpression and can be reused (the second (b - 1) expression can be ‚Äòeliminated‚Äô)</p>
<p>t = b - 1;  // store the subexpression in a temporary variable<br>
a = a + t;<br>
c = c + t;</p>
<p>For common subexpressions, you need to construct a directed acyclic graph (dag) of the expressions that occur inside your basic block. Every time you encounter a new expression (e.g. a higher node in the syntax tree), you check whether parts of it are already in the expression dag for this basic block, and add the expression, creating arrows pointing to its subexpressions. When the graph is done you can easily see what subexpressions are used multiple times, so you can store their value in a temporary variable and reuse it. See the picture for an example.</p>
<p>Loop optimizations A well-known bit of Programmer Wisdom is ‚Äúa program spends 90% of its execution time in 10% of the code‚Äù, and although these percentages differ per program, everyone will agree most of the running time is spent in inner loops.</p>
<p>So if we can somehow optimize those loops, we can save a LOT of time‚Ä¶ Well, there are several ways of saving time in loops; I will briefly discuss two of them, code motion and induction variables.</p>
<p>Code motion is kind of like subexpression elimination, but instead of doing so inside a basic block, it calculates an expression before the loop begins (thus before the basic block) and uses this value throughout the loop:</p>
<p>while ( i &lt;= limit-2 )</p>
<p>becomes</p>
<p>t = limit - 2;<br>
while ( i &lt;= t )</p>
<p>Loops may not have many constant expressions, though. What they often DO have is a loop counter, and this loop counter is used frequently for calculations like array indices, etc. That‚Äôs where induction variables can help us.</p>
<p>If j is our loop counter, and j * 4 is calculated for every loop iteration, we can introduce an induction variable and replace this multiply by an add:</p>
<p>for (j = 0; j &lt; n; j++)   {<br>
‚Ä¶ (j * 4) ‚Ä¶<br>
}</p>
<p>becomes</p>
<p>t = 0;<br>
for (j = 0; j &lt; n; j++)   {<br>
‚Ä¶    t    ‚Ä¶<br>
t += 4;<br>
}</p>
<p>Jump elimination Sometimes you can eliminate a jump by looking at its target block. For example, when you have:</p>
<p>1: jmp 7<br>
‚Ä¶<br>
7: str_equal<br>
8: jmpf 10<br>
9: ‚Ä¶</p>
<p>you can copy code from the target block and save a jump (if the condition is false):</p>
<p>1a: str_equal  // | copy of the target block<br>
1b: jmpf 10    // |<br>
1c: jmp  9     // if condition was true, goto 9<br>
‚Ä¶<br>
7: str_equal<br>
8: jmpf 10<br>
9: ‚Ä¶</p>
<p>It‚Äôs up to you to decide how large parts of code you‚Äôre willing to duplicate in order to eliminate one jump, but in inner loops it can save a lot of time.</p>
<p>Coming Up Next‚Ä¶</p>
<p>Hopefully with this information, your programs can become a little more efficient. Compiler code optimization is a very complex area though, and we‚Äôve covered only little bits of it. The Dragon book (see tut 1) covers a lot more of it, so check it out if you‚Äôre interested.</p>
<p>Next time we‚Äôll create our virtual machine, and maybe generate our virtual machine code too. Then we can finally run a program‚Ä¶ So all our work hasn‚Äôt been for nothing!</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>Somewhere on the wall a small white light flashed.</p>
<p>‚ÄúCome,‚Äù said Slartibartfast, ‚Äúyou are to meet the mice. Your arrival on the planet has caused considerable excitement. It has already been hailed, so I gather, as the third most improbable event in the history of the Universe.‚Äù</p>
<p>‚ÄúWhat were the first two?‚Äù</p>
<p>‚ÄúOh, probably just coincidences,‚Äù said Slartibartfast carelessly.</p>
<p>HHG 1:30 [br][size=1]Posted on: January 25, 2007, 10:03:58 PM[/size][hr]Introduction</p>
<p>We‚Äôve generated intermediate code in part 5 and we would like to convert it to executable code so we can execute a program. But I‚Äôve decided to create the virtual machine first, so we know what we‚Äôre dealing with when generating the executable.</p>
<p>The virtual machine is of course a very important component of a scripting engine. It‚Äôs where the code is executed at runtime, so it had better be fast. I won‚Äôt focus on speed this time though.</p>
<p>Oh yeah: you get my Amazing Stack Template absolutely FREE with this part, No Extra Charge! AND you get a cool string class that was written especially for this part, with at least 5 minutes work in it! Now that‚Äôs real value for your money!</p>
<p>But first, an explanation of different machine types. In tut 5 I just said what kind our VM would be, without explaining what other possibilities there were. Andy Campbell asked me about these other possibilites, and I figured other people might be interested, so here goes:</p>
<p>Machine Types</p>
<p>As said, our machine will be a stack machine. In real machines, stack CPUs were used for early computers (and may still used in simple devices today). The disadvantage is the many stack manipulations needed: a PUSH for every operand and a POP for every result. Often, though, you use the results directly for the next calculation so that‚Äôs not always necessary.</p>
<p>Most CPUs nowadays have registers (a very limited number of very fast memory locations) it operates on instead of just a stack; a stack is still used for passing parameters to functions. Machines that can only operate on registers are called load/store machines since you have to load each value before you use it and store each result after you calculate it.</p>
<p>Some processors only operate on memory data; no stack and no registers are used. Machines with this type of processor are called three-address machines because most instructions have three address operands (i.e. ADD dest, src1, src2). I don‚Äôt think they‚Äôre used much in hardware because of the limited memory bandwidth, but they ARE a viable option for virtual machines.</p>
<p>For virtual machines, the stack machine is very easy to implement because you don‚Äôt need temporary variables to store intermediate results when calculating an expression; you put everything on the stack (it‚Äôs very similar to the way you process a postfix expression). We WILL use temporaries here though, because I didn‚Äôt want to have to stack pointers. But more about that later.</p>
<p>It is not clear to me whether three-address machines might have an advantage; speed would be the most important one, and although I‚Äôve tried both I can‚Äôt say for certain which does fewer calculations in the most optimized case‚Ä¶ I do think it‚Äôs easier to optimize three-address code, so that may give this type of machine an advantage.</p>
<p>Java apparently uses a stack machine (I‚Äôm not familiar with the Java VM but I‚Äôve heard this).</p>
<p>A Virtual Piece of Cake</p>
<p>Our virtual machine object isn‚Äôt complicated at all. Its most important members are: an instruction array, a string table and a stack. It has three main interface functions: Reset, Read and Execute.</p>
<p>The instruction array contains the instructions that comprise our program. The instruction class is extremely simple and looks like the one we used for intermediate code in tut 5.</p>
<p>The string table is just an array of pointers that can either be NULL or point to a string that‚Äôs currently in use. This might be a program variable, or a temporary variable on the stack.</p>
<p>Our stack is made up of integers. They point to the string table so we know what string is actually on the stack. Why did I use integers and not just pointers to the string class? Because I wanted to keep things simple (for the readers, but also for myself :-): remember that we also want to stack booleans sometimes, so we would have to create a ‚Äòstack item‚Äô-class that could contain a string pointer or a boolean‚Ä¶ Now we just have an integer: if it‚Äôs non-negative, we know it points to a string, and if it‚Äôs negative it‚Äôs a boolean. It‚Äôs dirty coding, but it does the job and everyone can understand it. Don‚Äôt try this at home. Or rather, don‚Äôt do this on a real project.</p>
<p>Now, the interface functions. ‚ÄòReset‚Äô reinitializes the virtual machine. It‚Äôs a pathetically simple function.</p>
<p>‚ÄòRead‚Äô should read in the program. Next time we‚Äôll change this function so it reads from stdin, but for now it‚Äôs got a test program hardcoded into it. Change it if you like - just be very careful that the program stays correct, 'cause our VM does not crash gracefully.</p>
<p>‚ÄòExecute‚Äô runs the program currently in memory. This is also a simple function: it has an instruction pointer, it looks at an instruction and executes the right code using a switch statement. A little note about the temporary variables: whenever we put a variable on the stack, we need to have a copy of it: we can‚Äôt just push the variable‚Äôs index in the string table, because its value might change and then the value on the stack would also change. This is why, for almost every stack operation, NewTempCopy and DelTempCopy are used.</p>
<p>Some little notes on optimizing the VM: We should make sure our stack manipulation is as fast as possible; my stack template is not especially fast. The same goes for string manipulations. In general, you should make the common case fast. All normal optimization techniques apply on VMs as well.</p>
<p>There‚Äôs more to say on virtual machines: allocation schemes, garbage collection, keeping them both stable and fast, but I think I‚Äôll delay that till one of the next parts.</p>
<p>Next Time</p>
<p>Next time we‚Äôll FINALLY generate executable code. Then we‚Äôll be ‚Äúdone‚Äù with our simple scripting engine. After that I‚Äôll probably give an overview of the complexities of a real-life scripting engine, and talk about requested subjects. I‚Äôm no expert but I like to think that if you‚Äôve just learned something yourself, you can teach it more easily. So if there‚Äôs something about scripting you want to know, try me!</p>
<p>Jan Niestadt</p>
<p>Quote!</p>
<p>‚ÄúCome,‚Äù called the old man, ‚Äúcome now or you will be late.‚Äù</p>
<p>‚ÄúLate?‚Äù said Arthur. ‚ÄúWhat for?‚Äù</p>
<p>‚ÄúWhat is your name, human?‚Äù</p>
<p>‚ÄúDent. Arthur Dent,‚Äù said Arthur.</p>
<p>‚ÄúLate, as in the late Dentarthurdent,‚Äù said the old man, sternly. ‚ÄúIt‚Äôs a sort of threat you see.‚Äù Another wistful look came into his tired old eyes. ‚ÄúI‚Äôve never been very good at them myself, but I‚Äôm told they can be very effective.‚Äù</p>
<p>HHG 1:22</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T17:06:05Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:25:58Z' class='post-time'>
              July 30, 2016,  4:25am
            </time>
        <span itemprop='position'>#5</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Introduction</p>
<p>We have everything we need in order to execute our program, except‚Ä¶ executable code. We do have intermediate code and it‚Äôs already very close to the stuff our virtual machine understands. So all we have to do is a quick translation step between intermediate and executable code.</p>
<p>Why was this separate step necessary again? As you will see, the ‚Äútranslation‚Äù really comes down to putting our strings in an array and referring to them as indices instead of pointers to the symbol table. We already did jump targets last time, so they won‚Äôt change anymore. So this is a short part and the code changes aren‚Äôt big.</p>
<p>Maybe it wasn‚Äôt strictly necessary for us to create intermediate code. But when writing a more advanced compiler it‚Äôs useful to have a separate, more ‚Äòconceptual‚Äô stage before the actual machine code: it makes it easier to optimize the code, and you can retarget your compiler to another machine without much difficulties.</p>
<p>The Final Step</p>
<p>As you read the code for this part you‚Äôll notice my extreme laziness took control at some point and made me write really evil code‚Ä¶</p>
<p>For example, I‚Äôve combined the compiler and virtual machine into one program and I‚Äôm passing the <em>intermediate</em> code to the virtual machine, which isn‚Äôt the proper way of doing things. You‚Äôll probably want your compiler to handle everything up to the executable generation, then maybe store the executable in a file and have your VM read &amp; execute that file.</p>
<p>In our case, the Read() function in VMachine first gets all the strings from our symbol table and puts it in its string array. Then it walks through the code in a linear way and ‚Äòtranslates‚Äô it line by line. The special jump target instructions we used are just converted to NOP instructions, which should really be optimized away.</p>
<p>Oh, one particularly disgusting thing I did was store the string table index from the virtual machine in the symbol table from the compiler (using the symbol table‚Äôs new PutNo()/GetNo() members)‚Ä¶ It‚Äôs a very easy way to find the string index later, but you‚Äôll agree that modular programming is something entirely different‚Ä¶</p>
<p>It works! I can‚Äôt believe it!</p>
<p>Hey, you can actually run a program now with the compiler/virtual machine combination! You probably nearly gave up on that, didn‚Äôt you? Well, go ahead and try example.str on it, or ex2.str provided with this part‚Äôs source download‚Ä¶ They should execute correctly. Is that fun or what?</p>
<p>Well, that‚Äôs what we‚Äôve been working for all this time. A tiny language that, while it isn‚Äôt useful in itself, represents something very cool - you now know enough to write your own simple scripting engine!</p>
<p>So what happens now?</p>
<p>Well, after such an incredible climax (ahem) I‚Äôm sure you feel a bit empty and bewildered. Where do we go from here?</p>
<p>I will probably do one more part about some more advanced subjects, maybe talking about adding functions, classes, polymorphism, etc. to the language. Let me know what you‚Äôre interested in.</p>
<p>There won‚Äôt be any supporting code anymore though - everyone should be able to take the example compiler and expand it. Or, much better, write your own from scratch and get it right. The world‚Äôs your oyster!</p>
<p>Quote!</p>
<p>‚ÄúMore importantly, a towel has immense psychological value. For some reason, if a strag (strag: non-hitch hiker) discovers that a hitch hiker has his towel with him, he will automatically assume that he is also in possession of a toothbrush, face flannel, soap, tin of biscuits, flask, compass, map, ball of string, gnat spray, wet weather gear, space suit etc., etc. Furthermore, the strag will then happily lend the hitch hiker any of these or a dozen other items that the hitch hiker might accidentally have ‚Äúlost‚Äù. What the strag will think is that any man who can hitch the length and breadth of the galaxy, rough it, slum it, struggle against terrible odds, win through, and still knows where his towel is is clearly a man to be reckoned with.‚Äù</p>
<p>HHG 1:3</p>
<p>[br][size=1]Posted on: January 25, 2007, 10:05:18 PM[/size][hr]Introduction</p>
<p>Now that you have been playing with the finished scripting sample for a bit, and maybe have implemented some new features, you‚Äôre probably wondering when we‚Äôre getting to the good stuff.</p>
<p>Allow me to warn you that most this good stuff is a LOT of work (which is why I won‚Äôt present any more sample code :-). I will discuss several advanced scripting subjects and give a general idea how (I think) they‚Äôre implemented.</p>
<p>But first:</p>
<p>A lockup-resistent VM</p>
<p>Some time ago Joseph Hall gave me a great tip for dealing with infinite-looping script code. His idea is as follows: give the virtual machine a maximum number of opcodes to execute each time you call it, and let it resume next frame if it‚Äôs not done yet; this is the virtual equivalent to a CPU-burst in pre-emptive multitasking. This way your game engine can keep running even when your script code hangs; it could even automatically detect that the script is constantly looping (i.e. stuck in one part of the code) and reset the VM.</p>
<p>Now, let‚Äôs see how we could expand our language:</p>
<p>Functions</p>
<p>Adding functions to your scripting language isn‚Äôt very hard, but it introduces the new concepts of parameters and local variables. For both of these, the stack is used. Before a function call the application pushes the parameters onto the stack. The function then reserves space on the same stack for its local variables. Then the function executes, using the reserved stack space to read values from and write values into. In our sample compiler, we‚Äôve only pushed to and popped from the top of the stack, but now you also have to access memory adresses somewhere in the middle of the stack.</p>
<p>For functions you need two special opcodes: CALL and RETURN. CALL is an unconditional jump that saves the instruction pointer on the stack. RETURN is reads the stored instruction pointer and jumps back to the instruction after CALL.</p>
<p>The most logical thing to do is to let the caller (not the function) remove the parameters from the stack; after all, the caller put them there in the first place. This also allows for a simple mechanism of ‚Äúoutput parameters‚Äù: the function changes one of its parameters and the caller stores this value into a variable afterwards. A function‚Äôs return value can also be seen as an output parameter.</p>
<p>Function headers can be stored in the symbol table. With them you could store links to its parameters and local variables (which can each be separate symbol table entries). During code generation you can store the start address of the function in the symbol table as well.</p>
<p>Overloading<br>
Function overloading can be a very nice feature in a language, but implementing it can be tricky. The problem is finding the ‚Äúright‚Äù function to call in case none of the available function headers match exactly with the supplied parameter types. In this case, you will have to coerce some of the parameters to different types to get a complete match. The question is, of course, what parameters to coerce and what type to coerce them to. Most compilers try to match the call to each of the alternatives and choose the one with the smallest number of coercions. Some compilers allow double coercions (i.e. bool -&gt; int, then int -&gt; unsigned), further complicating matters. Keep it simple is my advice.</p>
<p>Operators can just be seen as functions that are called using a different syntax; if you treat all your operators this way (not making them actual function (slow) but rather inline functions or macros), you can easily extend function overloading to operator overloading.</p>
<p>Classes</p>
<p>If you want to implement classes in your language, decide exactly which features you want to support. Supporting full C++ classes, including multiple inheritance, access restrictions, dynamic casts, virtual functions, etc. is very hard and I don‚Äôt recommend starting with all that. A simple class system with single inheritance is a good starting point. You can always expand it later if the need arises.</p>
<p>Classes, and structs, are compound data types: they contain a number of data members, and are linked to a number of methods or member functions. You could store a member list in your symbol table, which links to other symbol table entries that are the separate members. This allows you to easily find the offset of a member in the structure.</p>
<p>Inheritance<br>
Single inheritance is relatively easy: when you‚Äôre looking for a member in an object, check whether the member‚Äôs in the child class; if not, check its parent class. The memory layout for child classes is very simple: first you store the parent, then its child, another child, etc. So downcasting is implicit: if you treat a Cat pointer as an Animal pointer, that simply means your program has access to fewer members, but the address of the pointer need not change.</p>
<p>Multiple inheritance introduces ambiguity problems when calling member functions or accessing data members. Consider this: Two classes ‚ÄòB‚Äô and ‚ÄòC‚Äô are child classes of the same class ‚ÄòA‚Äô. Then someone creates a class ‚ÄòD‚Äô that‚Äôs derived from both ‚ÄòB‚Äô and ‚ÄòC‚Äô. Now, if class ‚ÄòA‚Äô has a public member function DoSomething, and the programmer calls DoSomething on an object of type D, you don‚Äôt know which of the two DoSomething‚Äôs to call: the one that acts on the ‚ÄòA‚Äô part of ‚ÄòB‚Äô or on the ‚ÄòA‚Äô part of ‚ÄòC‚Äô‚Ä¶ Okay, maybe a picture will make it clearer:</p>
<p>Virtual functions<br>
Virtual functions are a way of creating polymorphic (lit. ‚Äúof many forms‚Äù) types; e.g. an Animal class that contains a virtual function MakeSound(), and child classes Cat and Dog that each implement these functions in a different way (I‚Äôll let you figure out how exactly they would implement them ;-). So when you call the MakeSound function of an Animal object, you don‚Äôt know (and don‚Äôt need to know) what kind of animal is making a sound.</p>
<p>Virtual functions are implemented by creating a so-called vtable. When the parent class declares a function as being virtual, it‚Äôs added to the vtable for that class. Each child class now gets its own version of the vtable, so that, although the caller sees no difference between the tables, different functions are called based on the object‚Äôs actual type.</p>
<p>Dynamic casts<br>
Dynamic casts can be handy: for example, in UnrealScript you can not only downcast an object (cast it to its parent type), but also upcast it (cast it to an object of a child class), if the object is indeed an object of the child class. This means you need a way of determining whether an object of type Parent is really a Child1 object that‚Äôs been cast down (in which case it can be cast up) or a Child2 object (in which case it can‚Äôt be cast up). In the latest C++ compilers you can do the same with the dynamic_cast&lt;‚Ä¶&gt; operator. How to determine this? Each object will have to have a unique identification number, perhaps an index to a table of classes and their parents. By using this number you can always tell what kind of object it really is.</p>
<p>Type variables<br>
Another fun thing is to allow type variables. This allows you to dynamically create objects of variable types. An example. Say you have a game with a cloning machine. An enemy walks in and two identical enemies walk out. You could use a big switch statement that contains all possible enemies, but that‚Äôs not a very extensible approach. So you store the enemy‚Äôs type and tell the game to create a monster of that type. In some imaginary language‚Äôs code:</p>
<p>TypeVar enemytype;           // A type variable<br>
enemytype = typeof (monster);       // Get the monster‚Äôs type<br>
Enemy *newmonster = new enemytype;  // Create a new monster of the same type</p>
<p>You can pass type variables to functions; this will make them very flexible indeed, as you can use the same function to create and manipulate many different kinds of objects!</p>
<p>For type variables you need to expand the table of classes and their parent class to include every class‚Äô size; otherwise you have no way of dynamically creating them.</p>
<p>Game-specific Language Constructs</p>
<p>UnrealScript was (as far as I know) the first language to offer two language features that are very useful in games: states and latent code.</p>
<p>States<br>
Classes in UnrealScript can have several states; an object is always in exactly one state. Based on which state the object is in, different functions are executed for that object. So if the object is an enemy and it‚Äôs in the Angry state, the Angry version of the function SeePlayer would be executed and the enemy would start attacking the player. If the enemy is in the Frightened state, another SeePlayer function (with the same parameter types) would be called and would make the enemy flee.</p>
<p>States aren‚Äôt very hard to add, although it requires some work; the state is an extra (invisible) class member and whenever a state-specific function is called the appropriate version of the function is executed. This could easilt be done with a jump table, using the state number as an index.</p>
<p>States can have their own out-of-function code, known in UnrealScript as state code. This is handy in combination with the next construct: latent functions.</p>
<p>Latent functions<br>
Latent functions are quite hard to implement, but very cool: a latent function takes some game time to execute; in other words, the process can start a function Wait or Animate that starts waiting or animating the creature, and when the animation is done the code resumes execution. This is a great feature to have for AI scripts.</p>
<p>The problem with (and strength of) latent code is that it‚Äôs essentially running in parallel with the other code. Every now and then a piece of latent code is executed, then it‚Äôs stopped again. So we have to remember the latent code instruction pointer. And when the object changes states, you‚Äôll also want it to execute other latent code.</p>
<p>We can see the reason UnrealScript only allow latent functions to be called from state code, not from normal functions: if latent functions could be called from anywhere, every object could essentially have many ‚Äòthreads‚Äô running in parallel‚Ä¶ this would require a lot of bookkeeping and would become slow. Also, synchronisation problems would occur: one object thread would set a member variable to a certain value, then another thread would become active and modify it again‚Ä¶ We would need to implement a full threading system if we wanted to allow this.</p>
<p>That‚Äôs it for now‚Ä¶</p>
<p>Well, I hope this got your imagination going. There‚Äôs lots of features your scripting language could offer; but you‚Äôre going to have to limit yourself to the ones you really need if you ever want to finish it.</p>
<p>This was probably the last part of this tutorial series. I really enjoyed writing it! If you feel some aspect has not gotten enough attention, let me know, and maybe I‚Äôll do an extra part. Of course, if you have any other questions I‚Äôd also like to hear from you.</p>
<p>Good luck, and keep on scripting! <img src="../../images/emoji/twitter/wink1bce.png?v=6" title=":wink:" class="emoji" alt=":wink:"></p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Mopman.html'><span itemprop='name'>Mopman</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-26T18:30:45Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:26:09Z' class='post-time'>
              July 30, 2016,  4:26am
            </time>
        <span itemprop='position'>#6</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I‚Äôm really not trying to be a dick, but I don‚Äôt see the point of posting this here. If I wanted to make a scripting language, I would google, and google would give me Flipcode. Original content ftw?</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/The_Un-Named.html'><span itemprop='name'>The_Un-Named</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-30T22:53:34Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:34:59Z' class='post-time'>
              July 30, 2016,  4:34am
            </time>
        <span itemprop='position'>#7</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>I‚Äôm with Mopman, you could have attached it or just linked to it.</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/usernamelol.html'><span itemprop='name'>usernamelol</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-31T00:50:36Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:35:11Z' class='post-time'>
              July 30, 2016,  4:35am
            </time>
        <span itemprop='position'>#8</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Yeah im not reading all of that lol. And also, they all say introductions?</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/wonderguy6.html'><span itemprop='name'>wonderguy6</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-01-31T12:16:49Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:36:26Z' class='post-time'>
              July 30, 2016,  4:36am
            </time>
        <span itemprop='position'>#9</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote no-group" data-post="8" data-topic="51940">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar/usernamelol/40/5_6259e4fa9dfe0dec282fb0955bb1974c.png" class="avatar"> usernamelol:</div>
<blockquote>
<p>Yeah im not reading all of that lol. And also, they all say introductions?</p>
</blockquote>
</aside>
<p>Well i took them of different pages an put em on a notepad and i lost the site and couldnt google it so i put it here :o</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/N00b1.html'><span itemprop='name'>N00b1</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-02-01T20:58:13Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:38:54Z' class='post-time'>
              July 30, 2016,  4:38am
            </time>
        <span itemprop='position'>#10</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote no-group" data-post="3" data-topic="51940">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forum.moparisthebest.com/wonderguy6/40/2762_2.png" class="avatar"> wonderguy6:</div>
<blockquote>
<p>Download the tutorial code (tut5.zip) (10k) [<a href="http://www.flipcode.com/articles/tut5.zip" rel="nofollow noopener">http://www.flipcode.com/articles/tut5.zip</a>]</p>
</blockquote>
</aside>
<p>i would start there if you cant find the link</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/kloplop321.html'><span itemprop='name'>kloplop321</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-02-01T21:31:04Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:38:57Z' class='post-time'>
              July 30, 2016,  4:38am
            </time>
        <span itemprop='position'>#11</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>lol, nice one.</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Freddy1990.html'><span itemprop='name'>Freddy1990</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-02-02T01:43:58Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:39:18Z' class='post-time'>
              July 30, 2016,  4:39am
            </time>
        <span itemprop='position'>#12</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>Hmm, i‚Äôd just write wode to interprete a script <img src="../../images/emoji/twitter/slight_smile1bce.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="1" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Mopman.html'><span itemprop='name'>Mopman</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-02-02T19:18:36Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:40:42Z' class='post-time'>
              July 30, 2016,  4:40am
            </time>
        <span itemprop='position'>#13</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <aside class="quote no-group quote-modified" data-post="12" data-topic="51940">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/forum.moparisthebest.com/freddy1990/40/85_2.png" class="avatar"> Freddy1990:</div>
<blockquote>
<p>Hmm, i‚Äôd just write wode to interprete a script <img src="../../images/emoji/twitter/slight_smile1bce.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</blockquote>
</aside>
<p>‚Ä¶ that‚Äôs what the tutorial is about?</p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>
  <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
      <div class='crawler-post-meta'>
        <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a itemprop="url" href='../../u/Freddy1990.html'><span itemprop='name'>Freddy1990</span></a>
          
        </span>

        <span class="crawler-post-infos">
            <meta itemprop='datePublished' content='2007-02-03T00:57:22Z'>
            <time itemprop='dateModified' datetime='2016-07-30T04:41:13Z' class='post-time'>
              July 30, 2016,  4:41am
            </time>
        <span itemprop='position'>#14</span>
        </span>
      </div>
      <div class='post' itemprop='articleBody'>
        <p>It is lol? hmm lol, didn‚Äôt read past the first line <img src="../../images/emoji/twitter/stuck_out_tongue1bce.png?v=6" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"> bit long <img src="../../images/emoji/twitter/slight_smile1bce.png?v=6" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
      </div>

      <meta itemprop='headline' content='Ever Wanted to make your own scripting language?'>

      <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
         <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
         <meta itemprop="userInteractionCount" content="0" />
         <span class='post-likes'></span>
       </div>

       <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
          <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
          <meta itemprop="userInteractionCount" content="0" />
        </div>


  </div>






    </div>
    <footer class="container wrap">
      <nav class='crawler-nav' itemscope itemtype='http://schema.org/SiteNavigationElement'>
        <ul>
        <li itemprop="name"><a href='../../index.html' itemprop="url">Home </a></li>
        <li itemprop="name"><a href='../../categories.html' itemprop="url">Categories </a></li>
        <li itemprop="name"><a href='../../guidelines.html' itemprop="url">FAQ/Guidelines </a></li>
        <li itemprop="name"><a href='../../tos.html' itemprop="url">Terms of Service </a></li>
        <li itemprop="name"><a href='../../privacy.html' itemprop="url">Privacy Policy </a></li>
        </ul>
      </nav>
      <p class='powered-by-link'>Powered by <a href="https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
    </footer>
    
  </body>
  

<!-- Mirrored from forum.moparisthebest.com/t/ever-wanted-to-make-your-own-scripting-language/51940 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 05 Aug 2019 19:49:05 GMT -->
</html>
